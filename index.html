<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Odpoƒçet k prvn√≠mu pivu üç∫</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
    background:linear-gradient(45deg,#ffcc00,#ff6600);
    font-family:Comic Sans MS,cursive;
    margin:0;
    color:#333;
}
.container{
    max-width:1200px;
    margin:auto;
    padding:15px;
    text-align:center;
    overflow-x:hidden;
}
h1{font-size:48px;margin:20px 0}
h2{margin-top:40px}
.tables{
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    justify-content:center;
}
.table-box{
    max-width:520px;
    width:100%;
}
table{
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:15px;
    overflow:hidden;
    box-shadow:0 4px 15px rgba(0,0,0,0.2);
}
th,td{
    border:1px solid #ccc;
    padding:12px;
    font-size:16px;
}
th{
    background:#ff9900;
    color:white;
}
.today{
    background:#ffe066;
    font-weight:bold;
}
input{
    width:100%;
    padding:10px;
    font-size:16px;
    box-sizing:border-box;
    border:1px solid #ccc;
    border-radius:6px;
}
button{
    padding:10px 16px;
    font-size:16px;
    background:#ff9900;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
}
button:hover{background:#ff7700}
.message{
    margin:30px auto;
    padding:20px;
    background:white;
    border-radius:15px;
    font-size:20px;
    max-width:900px;
    box-shadow:0 4px 15px rgba(0,0,0,0.2);
    min-height:60px;
}
.chart-container{
    width:100%;
    max-width:1000px;
    height:400px;
    margin:auto;
    background:white;
    border-radius:15px;
    padding:20px;
    box-shadow:0 4px 15px rgba(0,0,0,0.2);
    box-sizing:border-box;
}
canvas{
    width:100%;
    height:100%;
    display:block;
}
</style>
</head>
<body>
<div class="container">
<h1 id="time">00:00:00</h1>
<p style="font-size:24px">üç∫ Odpoƒçet k prvn√≠mu pivu üç∫</p>

<div class="tables">
<div class="table-box"><h2>Luk√°≈°</h2><table id="lukasTable"></table></div>
<div class="table-box"><h2>Martin</h2><table id="martinTable"></table></div>
</div>

<div class="message" id="msg">---</div>

<h2>üìà V√Ωvoj v√°hy ‚Äì √∫nor</h2>
<div class="chart-container">
  <canvas id="chart"></canvas>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

/************ THINGSPEAK ************/
const CHANNEL_ID="3249143";
const WRITE_API_KEY="H753ZAUO7U3LT3J6";
const READ_API_KEY="1RDF4Q2Y54BGZSNB"; // tv≈Øj Read API Key

/************ SPROST√â HLA≈†KY ************/
const messages=[
 "Ty vole, zase nahoru? ü§¶‚Äç‚ôÇÔ∏è",
 "Pivo tƒõ m√° rad≈°i ne≈æ ƒçinky üç∫",
 "Tohle u≈æ nen√≠ forma, to je koule üê∑",
 "Tren√©r by ti dal facku üòà",
 "Se≈æral jsi v noci ledniƒçku?",
 "Aspo≈à je v√≠c co milovat ‚ù§Ô∏è‚Äçüî•",
 "Jestli tohle je dieta, tak jsem pape≈æ ü§°"
];

/************ ODPoƒçet ************/
const year = new Date().getFullYear();
const lastDayFeb = new Date(year, 2, 0).getDate();
const endDate = new Date(year, 1, lastDayFeb, 23, 59, 59);

function updateCountdown() {
  const now = new Date();
  const diff = endDate - now;
  if (diff <= 0) {
    document.getElementById('time').innerText = "ƒåAS VYPR≈†EL! üç∫üç∫üç∫";
    return;
  }
  const hours = Math.floor(diff / 36e5);
  const minutes = Math.floor((diff % 36e5) / 6e4);
  const seconds = Math.floor((diff % 6e4) / 1e3);
  document.getElementById('time').innerText =
    `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

setInterval(updateCountdown, 1000);
updateCountdown();

/************ TABULKY ************/
const today = new Date().getDate();

function makeTable(id, name) {
  const table = document.getElementById(id);
  let html = `<tr><th>Den</th><th>V√°ha (kg)</th><th></th></tr>`;
  for (let d = 1; d <= lastDayFeb; d++) {
    const isToday = d === today;
    html += `
      <tr class="${isToday ? 'today' : ''}">
        <td>${d}. 2.${isToday ? ' (dnes) üç∫' : ''}</td>
        <td><input type="number" step="0.1" id="${name}${d}" placeholder="?.?"></td>
        <td><button onclick="save('${name}',${d})">‚úî Ulo≈æit</button></td>
      </tr>`;
  }
  table.innerHTML = html;
}

makeTable("lukasTable", "lukas");
makeTable("martinTable", "martin");

/************ ULO≈ΩEN√ç ************/
window.save = function(name, day) {
  const input = document.getElementById(name + day);
  const value = input.value.trim();
  if (!value || isNaN(value) || value < 40 || value > 200) {
    alert("Zadej re√°lnou v√°hu v kg (40‚Äì200)");
    input.focus();
    return;
  }
  const field = name === "lukas" ? 1 : 2;
  const url = `https://api.thingspeak.com/update?api_key=${WRITE_API_KEY}&field${field}=${value}&status=${name}-${day}`;

  const button = input.parentElement.parentElement.querySelector('button');
  button.disabled = true;
  button.textContent = "Ukl√°d√°m...";

  fetch(url)
    .then(r => r.text())
    .then(id => {
      if (id && id !== "0") {
        document.getElementById('msg').innerText = messages[Math.floor(Math.random() * messages.length)];
        setTimeout(() => document.getElementById('msg').innerText = "---", 5000);
        setTimeout(loadAll, 1500);
      } else alert("Chyba p≈ôi ukl√°d√°n√≠ ‚Äì zkuste to znovu");
    })
    .catch(() => alert("Nepoda≈ôilo se spojit s ThingSpeak"))
    .finally(() => {
      button.disabled = false;
      button.textContent = "‚úî Ulo≈æit";
    });
}

/************ NAƒåTEN√ç + GRAF (jen √∫nor) ************/
let chartInstance = null;

function loadAll() {
  fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_API_KEY}&results=300`)
    .then(r => r.json())
    .then(data => {
      const used = new Set();
      const labels = [];
      const lukasData = [];
      const martinData = [];

      // naplnƒõn√≠ input≈Ø jen √∫nor
      [...data.feeds].reverse().forEach(feed => {
        if (feed.status && !used.has(feed.status)) {
          const [n, day] = feed.status.split("-");
          const dayNum = parseInt(day, 10);
          if (dayNum < 1 || dayNum > lastDayFeb) return;
          used.add(feed.status);
          const el = document.getElementById(n + dayNum);
          const val = n === "lukas" ? feed.field1 : feed.field2;
          if (el && val != null) el.value = val;
        }
      });

      // p≈ôiprava dat pro graf
      for (let d = 1; d <= lastDayFeb; d++) {
        labels.push(d + ".2");
        const lukInput = document.getElementById("lukas" + d);
        const marInput = document.getElementById("martin" + d);
        lukasData.push(lukInput.value ? Number(lukInput.value) : null);
        martinData.push(marInput.value ? Number(marInput.value) : null);
      }

      drawChart(labels, lukasData, martinData);
    });
}

function drawChart(labels, lukas, martin) {
  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Luk√°≈°",
          data: lukas,
          borderColor: "#ff4444",
          backgroundColor: "rgba(255,68,68,0.2)",
          tension: 0.3,
          fill: false,
          spanGaps: true
        },
        {
          label: "Martin",
          data: martin,
          borderColor: "#4488ff",
          backgroundColor: "rgba(68,136,255,0.2)",
          tension: 0.3,
          fill: false,
          spanGaps: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: false, title: { display: true, text: "V√°ha (kg)" } },
        x: { title: { display: true, text: "Den (√∫nor)" } }
      },
      plugins: { legend: { position: "top" } }
    }
  });
}

loadAll();

}); // DOMContentLoaded
</script>
</body>
</html>
